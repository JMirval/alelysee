name: deploy

on:
  push:
    branches: [main, develop]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: Deployment target
        type: choice
        options: [dev, prod]
        default: dev

env:
  APP_NAME: alelysee
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
  RAILWAY_SERVICE_NAME: ${{ secrets.RAILWAY_SERVICE_NAME }}
  RAILWAY_ENV_DEV: ${{ vars.RAILWAY_ENV_DEV || 'dev' }}
  RAILWAY_ENV_PROD: ${{ vars.RAILWAY_ENV_PROD || 'prod' }}

jobs:
  deploy-dev:
    if: github.event_name == 'push' || github.event.inputs.environment == 'dev'
    runs-on: ubuntu-latest
    environment: ${{ vars.RAILWAY_ENV_DEV || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: curl -fsSL https://railway.app/install.sh | sh

      - name: Deploy to Railway (dev)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link --project "$RAILWAY_PROJECT_ID"
          railway up --service "$RAILWAY_SERVICE_NAME" --environment "$RAILWAY_ENV_DEV"

  deploy-prod:
    if: github.event_name == 'release' || github.event.inputs.environment == 'prod'
    runs-on: ubuntu-latest
    environment: ${{ vars.RAILWAY_ENV_PROD || 'prod' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: curl -fsSL https://railway.app/install.sh | sh

      - name: Deploy to Railway (prod)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link --project "$RAILWAY_PROJECT_ID"
          railway up --service "$RAILWAY_SERVICE_NAME" --environment "$RAILWAY_ENV_PROD"
